---
# tasks file for /etc/ansible/roles/gitbucket-worker

- name: Install the latest version of dependencies
  ansible.builtin.dnf:
    name: 
      - wget
      - unzip
      - tomcat
      - python3
      - nfs-utils
      - java-1.8.0-openjdk-devel
      - policycoreutils-python-utils
    state: latest

- name: Create "/gitbucket" directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: tomcat
    group: tomcat
    mode: '0755'
  with_items:
   - /gitbucket
   - /gitbucket/data
   - /gitbucket/tmp
   - /gitbucket/repositories
   - /gitbucket/gist  
   - /var/lib/tomcat/webapps/gitbucket

- name: Ensure SELinux is set to permissive mode
  ansible.builtin.lineinfile:
    path: /etc/selinux/config
    regexp: '^SELINUX='
    line: SELINUX=permissive

- name: Set SELinux to permissive mode
  ansible.builtin.command: setenforce 0

- name: Insert "JAVA_OPTS" configuration block in "/etc/tomcat/tomcat.conf"
  ansible.builtin.lineinfile:
    path: /etc/tomcat/tomcat.conf
    line: JAVA_OPTS="-Djava.security.egd=file:/dev/urandom -Dgitbucket.home=/gitbucket -Dgitbucket.disableCache=true -Dgitbucket.disableNewsFeed=true"

- name: Download and unarchive gitbucket.war
  ansible.builtin.unarchive:
    src: https://github.com/gitbucket/gitbucket/releases/download/{{gitbucket_version}}/gitbucket.war
    dest: /var/lib/tomcat/webapps/gitbucket
    remote_src: yes  
    owner: tomcat
    group: tomcat

- name: Permit traffic in public zone for 8080/tcp
  ansible.posix.firewalld:
    port: 8080/tcp
    zone: public
    state: enabled
    permanent: true
    immediate: true

  # firewalld
# - name: Add source range for public zone
#   ansible.posix.firewalld:
#     source: 10.26.0.0/24
#     zone: public
#     state: enabled
#     permanent: true
#     immediate: true

- name: Mount an NFS volume
  ansible.posix.mount:
    src: "{{nfs_server}}:{{ item }}"
    path: "{{ item }}"
    state: mounted
    fstype: nfs
  with_items:
   - /gitbucket/data
   - /gitbucket/tmp
   - /gitbucket/repositories
   - /gitbucket/gist

- name: Configure database.conf in "/gitbucket/database.conf"
  ansible.builtin.template:
    src: "database.conf.j2"
    dest: "/gitbucket/database.conf"
    owner: "tomcat"
    group: "tomcat"
    mode: "0755"   

- name: Change file ownership, group and permissions for "/gitbucket"
  ansible.builtin.file:
    path: "/gitbucket"
    owner: "tomcat"
    group: "tomcat"
    mode: "0755"   
    recurse: yes 
