---
# tasks file for /etc/ansible/roles/database
- name: Install the latest version of MySQL and dependencies
  ansible.builtin.dnf:
    name: 
      - mysql-server
      - mysql
      - python3-PyMySQL
      - python3-firewall
    state: latest

- name: Start service mysqld, if not started
  ansible.builtin.service:
    name: mysqld
    state: started

  # mysql_secure_installation
- name: Update MariaDB root password
  community.mysql.mysql_user: 
    name=root host={{item}} 
    password={{mysql_root_password}}
  with_items:
    - 127.0.0.1
    - ::1
    - localhost

- name: Set ~/.my.cnf file
  template: src=dotmy.cnf.j2 dest=/root/.my.cnf mode=0600

  # mysql_secure_installation
- name: Delete anonymous MySQL user
  community.mysql.mysql_user: 
    name="" host={{item}} 
    state=absent
  with_items:
    - localhost
    - "{{ansible_nodename}}"

  # mysql_secure_installation
- name: Delete Hostname based MySQL user
  community.mysql.mysql_user: 
    name=root host="{{ansible_nodename}}" 
    state=absent

  # mysql_secure_installation
- name: Remove MySQL test database
  community.mysql.mysql_db: 
    name=test 
    state=absent

- name: permit traffic in default zone for mysql service
  ansible.posix.firewalld:
    service: mysql
    zone: public
    permanent: true
    state: enabled

- name: permit traffic in default zone for mysql service
  ansible.posix.firewalld:
    source: 10.26.0.0/24
    zone: public
    state: enabled
    permanent: true